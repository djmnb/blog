

# bochs安装



## 依赖库安装

```sh
sudo yum install gtk2 gtk2-devel libXt libXt-devel libXpm libXpm-devel SDL SDL-devel libXrandr-devel.x86_64 xorg-x11-server-devel glibc-headers gcc-c++ SDL SDL-devel
```



## 安装bochs

```sh
wget https://sourceforge.net/projects/bochs/files/bochs/2.6.8/bochs-2.6.8.tar.gz

tar xvfz bochs-2.6.8.tar.gz
```



## 配置文件

进入到bochs-2.6.8

```
./configure --with-x11 --with-wx --enable-debugger --enable-disasm --enable-all-optimizations --enable-readline --enable-long-phy-address --enable-ltdl-install --enable-idle-hack --enable-plugins --enable-a20-pin --enable-x86-64 --enable-smp --enable-cpu-level=6 --enable-large-ramfile --enable-repeat-speedups --enable-fast-function-calls  --enable-handlers-chaining  --enable-trace-linking --enable-configurable-msrs --enable-show-ips --enable-cpp --enable-debugger-gui --enable-iodebug --enable-logging --enable-assert-checks --enable-fpu --enable-vmx=2 --enable-svm --enable-3dnow --enable-alignment-check  --enable-monitor-mwait --enable-avx  --enable-evex --enable-x86-debugger --enable-pci --enable-usb --enable-voodoo
```

## 复制文件

```
cp misc/bximage.cpp  misc/bximage.cc
cp iodev/hdimage/hdimage.cpp iodev/hdimage/hdimage.cc
cp iodev/hdimage/vmware3.cpp  iodev/hdimage/vmware3.cc
cp iodev/hdimage/vmware4.cpp iodev/hdimage/vmware4.cc
cp iodev/hdimage/vpc-img.cpp iodev/hdimage/vpc-img.cc
cp iodev/hdimage/vbox.cpp iodev/hdimage/vbox.cc
```

## 构建

```
sudo make && sudo make install
```

![image-20230930223054400](../../img/环境搭建assets/image-20230930223054400.png)

显示是这样就代表安装成功了

然后可以查看/usr/local/share  /usr/local/bin 下面就有了 对应的东西

## 创建硬盘

> 不同的bochs对应的bximage参数可能不同

```
bximage -mode=create -hd=16 -imgmode=flat -q master.img
```

> ata0-master: type=disk, path="master.img", mode=flat

## 编写boot.asm

```
[org 0x7c00]

; 设置屏幕模式为文本模式，清除屏幕
mov ax, 3
int 0x10

; 初始化段寄存器
mov ax, 0
mov ds, ax
mov es, ax
mov ss, ax
mov sp, 0x7c00

mov si, 0

; 屏幕显示区域
mov ax,0xb800
mov ds,ax
; 显示字符H
mov byte [0],'H'   

; 阻塞
jmp $


; 填充 0
times 510 - ($ - $$) db 0

; 主引导扇区的最后两个字节必须是 0x55 0xaa
; dw 0xaa55
db 0x55, 0xaa
```

编译boot.asm

```
nasm -f bin boot.asm -o boot.bin
```

将boot.bin写入主引导扇区

```
dd if=boot.bin of=master.img bs=512 count=1 conv=notrunc
```

# qemu安装

进入到root用户

```
yum install qemu-kvm
```

## 转换磁盘镜像文件

```
qemu-img convert -f raw -O vmdk master.img master.vmdk
```



# 参考

文章链接:

* [bochs配置](https://www.jianshu.com/p/00969a32dfae)
* [bochs配置](https://zhuanlan.zhihu.com/p/452578845)

书籍参考:

* 一个64位操作系统的设计与实现
